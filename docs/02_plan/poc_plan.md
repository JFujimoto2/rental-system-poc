# 賃貸管理システム リプレイス PoC 計画書

## 1. 概要

### 1.1 背景

- 現行システム：Java 6 / Oracle ベースの独自フレームワーク（2009年頃構築）
- 月額保守費：約800万円
- 課題：
  - 独自フレームワークによりソースコードの追跡が困難
  - プロセス定義が JAR ファイルに格納されており、ルーティングが不透明
  - リファクタリングが現実的ではない複雑な構造

### 1.2 目的

Ruby on Rails による自社内製でのリプレイスが技術的に実現可能かを検証する。

### 1.3 期間

2025年2月〜2025年3月末（約2ヶ月）

### 1.4 スコープ

- 検証環境のみで実施（本番環境には一切影響なし）
- 既存DBのコピー（匿名化済み）を使用
- 業務への影響ゼロ

### 1.5 期待効果

- 年間約1億円（月800万円×12ヶ月）の保守費削減の可能性
- 開発環境の近代化（SVN→GitHub、オンプレ→AWS）
- 自社でのシステム改修が可能になり、ベンダー依存からの脱却

-----

## 2. 環境比較

### 2.1 現行環境 vs PoC 環境

|項目         |現行       |PoC            |
|-----------|---------|---------------|
|**IDE**    |Eclipse  |VSCode / Cursor|
|**言語**     |Java 6   |Ruby 3.3       |
|**フレームワーク**|独自フレームワーク|Rails 8.1      |
|**ビルド**    |Maven    |Bundler        |
|**APサーバー** |Tomcat 7 |Puma（Rails内蔵）  |
|**DB**     |Oracle   |PostgreSQL     |
|**ソース管理**  |SVN      |GitHub         |
|**インフラ**   |オンプレサーバー |AWS            |
|**コンテナ**   |なし       |Docker         |
|**CI/CD**  |なし       |GitHub Actions |

### 2.2 PoC 環境構成

社内で既に利用している AWS / GitHub を活用し、追加コストを最小化する。

#### AWS アカウント運用方針（要確認）

既存 AWS アカウントは別プロジェクト用のため、以下いずれかで対応する。

|方針            |内容                        |メリット |デメリット  |
|--------------|--------------------------|-----|-------|
|A. 既存アカウントに間借り|VPC を分けて作成、タグで費用管理        |手続き簡単|誤操作リスク |
|B. 新規アカウント作成  |Organizations でメンバーアカウント追加|完全分離 |初期設定の手間|

**確認事項**

- [ ] AWS 管理者は誰か
- [ ] 新規アカウント作成の可否
- [ ] 既存アカウント利用時のルール（命名規則、タグ等）

```
┌─────────────────────────────────────────────────────────────┐
│  AWS（社内既存アカウント利用）                                │
│                                                             │
│   ┌─────────────────┐     ┌─────────────────┐              │
│   │  EC2 / ECS      │────▶│     RDS         │              │
│   │  (Docker)       │     │  (PostgreSQL)   │              │
│   │                 │     │                 │              │
│   │  Rails App      │     │                 │              │
│   └─────────────────┘     └─────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐
│ GitHub（社内）   │
│ リポジトリ       │──── GitHub Actions (CI)
└─────────────────┘
```

### 2.3 PoC 環境コスト

|サービス          |スペック       |月額目安         |
|--------------|-----------|-------------|
|EC2           |t3.small   |約$15〜20      |
|RDS PostgreSQL|db.t3.micro|約$15〜20      |
|**合計**        |           |**約$30〜40/月**|

※ 社内 AWS アカウントを利用するため、新規契約不要

### 2.4 Docker 構成

```yaml
# docker-compose.yml
services:
  web:
    build: .
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://postgres:password@db:5432/app
      
  db:
    image: postgres:16
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password

volumes:
  postgres_data:
```

-----

## 3. 事前確認事項（社内ヒアリング）

### 3.1 アプラス連携（口座振替代行）

|#|確認項目                     |確認先|ステータス|
|-|-------------------------|---|-----|
|1|ファイルフォーマット（全銀？独自CSV？固定長？）|   |☐ 未確認|
|2|連携タイミング（日次？月次？）          |   |☐ 未確認|
|3|送信方法（SFTP？画面アップロード？）     |   |☐ 未確認|
|4|結果ファイルの形式                |   |☐ 未確認|
|5|連携仕様書の有無・入手可否            |   |☐ 未確認|

### 3.2 OBIC連携（会計・仕訳）

|#|確認項目                  |確認先|ステータス|
|-|----------------------|---|-----|
|1|連携方式（CSV？API？ファイル転送？） |   |☐ 未確認|
|2|仕訳生成のタイミング（入金時？月次締め時？）|   |☐ 未確認|
|3|勘定科目のマッピング表           |   |☐ 未確認|
|4|連携仕様書の有無・入手可否         |   |☐ 未確認|

### 3.3 既存システム・データ

|#|確認項目                |確認先|ステータス|
|-|--------------------|---|-----|
|1|Oracle バージョン        |   |☐ 未確認|
|2|Oracle テーブル定義書 / ER図|   |☐ 未確認|
|3|本番DBサイズ（GB）         |   |☐ 未確認|
|4|データ量（主要テーブルのレコード数）  |   |☐ 未確認|
|5|同時利用ユーザー数           |   |☐ 未確認|
|6|個人情報の匿名化ルール         |   |☐ 未確認|
|7|検証用データ抽出の許可         |   |☐ 未確認|

### 3.4 業務ロジック

|#|確認項目              |確認先|ステータス|
|-|------------------|---|-----|
|1|締め処理の詳細フロー（日次・月次） |   |☐ 未確認|
|2|オーナー別催促ロジックのパターン一覧|   |☐ 未確認|
|3|入金消込のルール          |   |☐ 未確認|
|4|仕訳生成のルール          |   |☐ 未確認|

### 3.5 体制・運用

|#|確認項目         |確認先|ステータス|
|-|-------------|---|-----|
|1|既存システムの保守ベンダー|   |☐ 未確認|
|2|保守契約の更新時期    |   |☐ 未確認|

### 3.6 AWS / 開発環境

|#|確認項目                           |確認先|ステータス|
|-|-------------------------------|---|-----|
|1|AWS 管理者は誰か                     |   |☐ 未確認|
|2|PoC 用アカウント作成 or 既存アカウント利用      |   |☐ 未確認|
|3|既存アカウント利用時のルール（命名規則、タグ等）       |   |☐ 未確認|
|4|GitHub Organization / リポジトリ作成権限|   |☐ 未確認|

-----

## 4. PoC 検証項目

### 4.1 データ移行検証

#### 目的

Oracle から PostgreSQL へのデータ移行が現実的に可能かを確認する。

#### 検証内容

|#|項目       |詳細                                                       |成果物     |
|-|---------|---------------------------------------------------------|--------|
|1|データ型マッピング|Oracle固有型（NUMBER, VARCHAR2, DATE等）のPostgreSQL対応型への変換ルール策定|マッピング定義書|
|2|文字コード変換  |Shift_JIS / EUC-JP → UTF-8 変換の検証                         |変換スクリプト |
|3|移行スクリプト作成|主要テーブル（10〜20テーブル程度）の移行スクリプト                              |移行スクリプト |
|4|データ整合性検証 |件数一致、NULL値、外部キー整合性の確認                                    |検証レポート  |
|5|移行時間計測   |本番想定データ量での移行所要時間                                         |計測結果    |

#### 完了条件

- [ ] 主要テーブルの移行スクリプトが動作する
- [ ] 移行後のデータ整合性が確認できる
- [ ] 移行時間が許容範囲内（目安：数時間以内）

-----

### 4.2 Excel インポート機能

#### 目的

現行の Excel 入力ワークフローを Rails で再現できることを確認する。

#### 検証内容

|#|項目           |詳細                                    |成果物        |
|-|-------------|--------------------------------------|-----------|
|1|Excelファイル読み込み|roo gem または creek gem を使用した .xlsx 読み込み|サンプルコード    |
|2|バリデーション      |必須項目、データ型、マスタ存在チェック                   |バリデーションロジック|
|3|エラーハンドリング    |行単位のエラー表示、一括取り込み可否判定                  |エラー画面      |
|4|取り込み確認画面     |プレビュー表示、確定処理                          |画面プロトタイプ   |

#### 完了条件

- [ ] 現行と同じフォーマットの Excel が取り込める
- [ ] バリデーションエラーが適切に表示される
- [ ] 取り込み結果が DB に正しく保存される

-----

### 4.3 締め処理

#### 目的

日次・月次の締め処理ロジックが Rails で実装可能かを確認する。

#### 検証内容

|#|項目        |詳細            |成果物        |
|-|----------|--------------|-----------|
|1|締め日判定ロジック |日次締め、月次締めの判定  |Service クラス|
|2|データロック    |締め後のデータ変更禁止制御 |ロックロジック    |
|3|集計処理      |締め対象期間の金額集計   |集計ロジック     |
|4|締め取消      |誤締めした場合の取消処理  |取消ロジック     |
|5|トランザクション制御|複数テーブル更新の整合性担保|トランザクション実装 |

#### 完了条件

- [ ] 締め処理が正常に完了する
- [ ] 締め後のデータが変更不可になる
- [ ] 締め取消が正常に動作する
- [ ] 同時実行でもデータ不整合が起きない

-----

### 4.4 オーナー別催促ロジック

#### 目的

オーナーごとに異なる催促ルールを柔軟に実装できることを確認する。

#### 検証内容

|#|項目             |詳細               |成果物          |
|-|---------------|-----------------|-------------|
|1|催促パターン整理       |現行の催促ルールを分類・整理   |パターン一覧       |
|2|Strategy パターン実装|オーナーごとの催促ロジック切り替え|Strategy クラス群|
|3|設定画面           |オーナーごとの催促設定      |設定画面プロトタイプ   |
|4|催促対象抽出         |未入金 × 催促ルールでの対象抽出|抽出ロジック       |

#### サンプル設計

```ruby
# app/services/reminder_strategies/base_strategy.rb
class ReminderStrategies::BaseStrategy
  def should_remind?(payment)
    raise NotImplementedError
  end
  
  def reminder_message(payment)
    raise NotImplementedError
  end
end

# app/services/reminder_strategies/standard_strategy.rb
class ReminderStrategies::StandardStrategy < BaseStrategy
  def should_remind?(payment)
    payment.due_date < Date.current && payment.unpaid?
  end
end

# app/services/reminder_strategies/lenient_strategy.rb
class ReminderStrategies::LenientStrategy < BaseStrategy
  def should_remind?(payment)
    payment.due_date < 7.days.ago && payment.unpaid?
  end
end
```

#### 完了条件

- [ ] 複数の催促パターンが実装できている
- [ ] オーナーごとに催促ロジックが切り替わる
- [ ] 新しい催促パターンの追加が容易

-----

### 4.5 アプラス向けファイル生成

#### 目的

口座振替依頼ファイルを現行システムと同じ形式で出力できることを確認する。

#### 検証内容

|#|項目      |詳細                 |成果物          |
|-|--------|-------------------|-------------|
|1|フォーマット解析|現行出力ファイルの構造解析      |フォーマット定義書    |
|2|ファイル生成  |Rails からの振替依頼ファイル出力|Generator クラス|
|3|現行比較    |同一入力での出力ファイル比較     |差分検証結果       |

#### サンプル設計

```ruby
# app/services/aplus/request_file_generator.rb
class Aplus::RequestFileGenerator
  def initialize(payments)
    @payments = payments
  end
  
  def generate
    header + body + trailer
  end
  
  private
  
  def header
    # ヘッダーレコード生成
  end
  
  def body
    @payments.map { |p| payment_record(p) }.join
  end
  
  def trailer
    # トレーラーレコード生成
  end
end
```

#### 完了条件

- [ ] 現行と同一フォーマットのファイルが出力できる
- [ ] 現行出力と diff で差分がない（同一入力の場合）

-----

### 4.6 アプラス結果取り込み・消込

#### 目的

振替結果ファイルを取り込み、入金消込が正しく行えることを確認する。

#### 検証内容

|#|項目       |詳細                 |成果物         |
|-|---------|-------------------|------------|
|1|結果ファイル解析 |振替結果ファイルの構造解析      |フォーマット定義書   |
|2|取り込み処理   |ファイル読み込み・パース       |Importer クラス|
|3|消込処理     |成功→入金済み、失敗→催促対象への更新|消込ロジック      |
|4|エラーハンドリング|不明レコード、重複取り込み対応    |エラー処理       |

#### サンプル設計

```ruby
# app/services/aplus/result_file_importer.rb
class Aplus::ResultFileImporter
  def initialize(file)
    @file = file
  end
  
  def import
    parse_records.each do |record|
      payment = find_payment(record)
      
      if record.success?
        payment.mark_as_paid!(record.transfer_date)
      else
        payment.mark_as_failed!(record.error_code)
      end
    end
  end
end
```

#### 完了条件

- [ ] 結果ファイルが正しくパースできる
- [ ] 成功レコードが入金済みに更新される
- [ ] 失敗レコードが催促対象になる

-----

### 4.7 OBIC向け仕訳ファイル生成

#### 目的

会計システム（OBIC）向けの仕訳データを現行と同じ形式で出力できることを確認する。

#### 検証内容

|#|項目       |詳細            |成果物          |
|-|---------|--------------|-------------|
|1|フォーマット解析 |現行出力ファイルの構造解析 |フォーマット定義書    |
|2|勘定科目マッピング|業務→会計の科目変換テーブル|マッピングテーブル    |
|3|仕訳生成ロジック |取引種別→仕訳パターンの変換|Generator クラス|
|4|現行比較     |同一入力での出力ファイル比較|差分検証結果       |

#### サンプル設計

```ruby
# app/services/obic/journal_entry_generator.rb
class Obic::JournalEntryGenerator
  def initialize(transactions)
    @transactions = transactions
  end
  
  def generate
    @transactions.map { |t| to_journal_entry(t) }
  end
  
  private
  
  def to_journal_entry(transaction)
    {
      date: transaction.date,
      debit_account: map_account(transaction.debit_type),
      debit_amount: transaction.amount,
      credit_account: map_account(transaction.credit_type),
      credit_amount: transaction.amount,
      description: transaction.description
    }
  end
end
```

#### 完了条件

- [ ] 現行と同一フォーマットのファイルが出力できる
- [ ] 勘定科目が正しくマッピングされる

-----

## 5. 技術スタック

### 5.1 使用技術

|カテゴリ   |技術            |バージョン|用途           |
|-------|--------------|-----|-------------|
|言語     |Ruby          |3.3.x|-            |
|フレームワーク|Ruby on Rails |8.1.x|Webアプリケーション  |
|データベース |PostgreSQL    |16.x |データストア       |
|認証     |Devise        |4.x  |ユーザー認証       |
|認可     |Pundit        |2.x  |権限管理         |
|ジョブ    |Solid Queue   |-    |バックグラウンド処理   |
|CSS    |Tailwind CSS  |4.x  |UI スタイリング    |
|Excel処理|roo           |-    |Excelファイル読み込み|
|コンテナ   |Docker        |-    |開発・実行環境      |
|CI/CD  |GitHub Actions|-    |自動テスト・デプロイ   |
|AI開発支援 |Claude Code   |-    |コード生成・レビュー支援 |

### 5.2 GitHub リポジトリ構成

```
rental-system-poc/
├── .github/
│   └── workflows/
│       └── ci.yml          # テスト自動実行
├── app/
├── config/
├── db/
├── docker/
│   └── Dockerfile
├── docker-compose.yml
├── Gemfile
└── README.md
```

-----

## 6. 体制・工数

### 6.1 実施体制

|役割     |担当           |備考        |
|-------|-------------|----------|
|PoC 実施 |自分           |フルコミット    |
|業務ヒアリング|自分           |既存業務担当者へ確認|
|レビュー・承認|課長 → 部長 → 本部長|段階的に報告    |

### 6.2 工数配分

|項目     |工数        |
|-------|----------|
|PoC 作業 |2ヶ月間フルコミット|
|事前ヒアリング|随時        |
|報告・レビュー|週1回程度     |

### 6.3 PoC 費用

|項目                 |費用                    |
|-------------------|----------------------|
|AWS（検証環境）          |約$30〜40/月 × 2ヶ月 = 約1万円|
|Claude Code（AI開発支援）|$100/月 × 2ヶ月 = 約3万円   |
|人件費                |自分の工数（通常業務として実施）      |
|**合計**             |**約4万円**              |

※ 外注費ゼロ、既存 AWS / GitHub 利用のため追加契約不要

### 6.4 Claude Code について

AI によるコーディング支援ツール。ターミナルから直接 Claude に指示を出し、コード生成・修正・レビューを効率化できる。

**導入メリット**

- コード生成の高速化（ボイラープレート、テスト等）
- Rails のベストプラクティスに沿った実装支援
- 一人での開発でもレビュー相当の品質担保

**費用対効果**

- 月額 $100（約1.5万円）
- 開発速度 1.5〜2倍の効率化が見込める
- 2ヶ月の PoC 期間で十分にペイする

-----

## 7. スケジュール

### 7.1 全体スケジュール

```
2025年
2月                              3月
|----|----|----|----|----|----|----|----|
W1   W2   W3   W4   W5   W6   W7   W8
                                      ▲
[事前確認・環境構築]                    │
|---------|                            │
     [データ移行検証]                   │
     |--------------|                  │
          [Excel/締め/催促]             │
          |------------------|          │
                    [外部連携検証]       │
                    |--------------|    │
                              [まとめ]  │
                              |--------|
                                   完了
```

### 7.2 週次計画

|週 |期間       |主な作業                        |
|--|---------|----------------------------|
|W1|2/3〜2/7  |事前確認完了、開発環境構築、Rails プロジェクト作成|
|W2|2/10〜2/14|データ移行スクリプト作成、主要テーブル移行       |
|W3|2/17〜2/21|Excel インポート、基本CRUD          |
|W4|2/24〜2/28|締め処理ロジック                    |
|W5|3/3〜3/7  |オーナー別催促ロジック                 |
|W6|3/10〜3/14|アプラス連携（ファイル生成・取り込み）         |
|W7|3/17〜3/21|OBIC連携（仕訳ファイル生成）            |
|W8|3/24〜3/31|総合検証、ドキュメント整理、報告書作成         |

-----

## 8. 成果物一覧

### 8.1 PoC 完了時の成果物

|#|成果物               |説明                 |
|-|------------------|-------------------|
|1|検証用 Rails アプリケーション|動作するプロトタイプ         |
|2|データ移行スクリプト        |Oracle → PostgreSQL|
|3|検証結果報告書           |各検証項目の結果・課題        |
|4|工数見積り             |本開発時の概算工数          |
|5|リスク・課題一覧          |検証で判明した課題          |

### 8.2 PoC 完了判定基準

|#|判定項目      |基準                 |
|-|----------|-------------------|
|1|データ移行     |主要テーブルの移行スクリプトが動作する|
|2|Excel 取り込み|現行フォーマットのファイルが取り込める|
|3|締め処理      |日次/月次締めのプロトタイプが動作する|
|4|催促ロジック    |オーナー別の分岐が実装できている   |
|5|アプラス連携    |同一フォーマットのファイルが出力できる|
|6|OBIC連携    |同一フォーマットのファイルが出力できる|

-----

## 9. リスクと対策

|#|リスク      |影響        |対策            |
|-|---------|----------|--------------|
|1|仕様書が存在しない|連携フォーマット不明|現行出力ファイルから逆解析 |
|2|業務ロジックが複雑|実装工数増大    |スコープを絞って段階的に検証|
|3|データ移行の問題 |文字化け、型不一致 |早期にサンプルデータで検証 |
|4|工数不足     |検証未完了     |優先度をつけて重要機能に集中|

-----

## 10. 提案の進め方

### 10.1 承認フロー

```
課長 → 部長 → 本部長
```

### 10.2 提案ポイント

#### 課長向け（技術的な話より「リスクが低い」を強調）

- 本番には一切触らない検証環境での実施
- ダメでも既存システム延命に戻すだけ
- 月800万の保守費削減の可能性を探りたい
- 3月末までに判断材料を出す

#### 部長・本部長向け（コスト削減効果を数字で）

- 年間約1億円の保守費
- 内製化で大幅削減の可能性
- PoC 費用はほぼゼロ（既存AWS/GitHub利用、自分の工数のみ）
- 失敗しても既存システム延命で業務影響なし

-----

## 11. 次のステップ（PoC 後）

### PoC 成功の場合

1. 本開発の計画策定
1. 段階的移行計画（ストラングラーパターン）
1. 予算・体制の確保

### PoC で課題が判明した場合

1. 課題の深掘り・対策検討
1. 追加検証の実施
1. または既存システム延命の判断

-----

## 付録

### A. 参考：想定ディレクトリ構成

```
app/
├── controllers/
│   └── admin/
│       ├── base_controller.rb
│       ├── payments_controller.rb
│       ├── invoices_controller.rb
│       └── owners_controller.rb
├── models/
│   ├── payment.rb
│   ├── invoice.rb
│   ├── owner.rb
│   └── journal_entry.rb
├── services/
│   ├── billing/
│   │   ├── closing_service.rb
│   │   └── reminder_service.rb
│   ├── reminder_strategies/
│   │   ├── base_strategy.rb
│   │   ├── standard_strategy.rb
│   │   └── lenient_strategy.rb
│   ├── aplus/
│   │   ├── request_file_generator.rb
│   │   └── result_file_importer.rb
│   ├── obic/
│   │   └── journal_entry_generator.rb
│   └── excel/
│       └── payment_importer.rb
└── views/
    └── admin/
```

### B. 用語集

|用語         |説明                     |
|-----------|-----------------------|
|アプラス       |口座振替代行サービス             |
|OBIC       |会計システム                 |
|締め処理       |一定期間のデータを確定させる処理       |
|消込         |入金と請求を突合して処理済みにすること    |
|仕訳         |取引を勘定科目に分類して記録すること     |
|ストラングラーパターン|既存システムを段階的に新システムへ移行する手法|

-----

*作成日: 2025年1月28日*
*更新日: 2025年1月28日*