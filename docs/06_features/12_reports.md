# 帳票・レポート

## ステータス: 実装済

## 概要

物件別収支サマリ、債権滞留表（エイジング分析）、入金実績レポートの3種類のレポートを提供する。
既存システムの「債権滞留表」「残高照会」「仕訳照会」に相当する。

経営判断や日常の入出金管理に必要なデータを集約・可視化する機能。
新規テーブル不要、既存データの集計のみで実現。

## レポート一覧

### 1. 物件別収支サマリ（Property P&L）

建物ごとの収支を一覧表示する。

| 項目 | 内容 |
|------|------|
| パス | GET /reports/property_pl |
| 転貸収入 | 対象期間の `TenantPayment`（paid）の `paid_amount` 合計 |
| 保証賃料支出 | 対象期間の `OwnerPayment`（paid）の `net_amount` 合計 |
| 収支差額 | 転貸収入 − 保証賃料支出 |
| 入居率 | 入居中部屋数 / 総部屋数 × 100 |

#### 期間フィルタ
- 開始日・終了日を指定して集計期間を変更可能
- デフォルト: 当月（月初〜月末）

#### CSV 出力カラム
建物名, オーナー, 転貸収入, 保証賃料支出, 収支差額, 総部屋数, 入居数, 入居率

---

### 2. 債権滞留表（Aging Report）

滞納中の入金予定をエイジング区分ごとに分類表示する。

| 項目 | 内容 |
|------|------|
| パス | GET /reports/aging |
| 対象 | `TenantPayment` の `overdue` / `partial` / `unpaid`（期日超過） |

#### エイジング区分
| 区分 | 条件 |
|------|------|
| 〜30日 | 滞納日数 ≤ 30日 |
| 31〜60日 | 31日 ≤ 滞納日数 ≤ 60日 |
| 61〜90日 | 61日 ≤ 滞納日数 ≤ 90日 |
| 90日超 | 滞納日数 > 90日 |

#### CSV 出力カラム
エイジング, 入居者, 建物, 部屋, 入金期日, 滞納日数, 請求金額, 入金額, 未収額

---

### 3. 入金実績レポート（Payment Summary）

月別の入金予定 vs 実績を集計表示する。

| 項目 | 内容 |
|------|------|
| パス | GET /reports/payment_summary |
| 予定件数 | 対象月の `TenantPayment` 全件 |
| 入金件数 | `status: :paid` の件数 |
| 入金率 | 入金件数 / 予定件数 × 100 |

#### 期間フィルタ
- 開始月・終了月を指定して集計範囲を変更可能
- デフォルト: 6ヶ月前〜当月

#### 入金方法別内訳
| 方法 | enum 値 |
|------|---------|
| 振込 | transfer |
| 口座振替 | direct_debit |
| 現金 | cash |

#### CSV 出力カラム
対象月, 予定件数, 入金件数, 予定金額, 入金額, 入金率, 振込, 口座振替, 現金

## 画面一覧

| パス | 画面 | 説明 |
|------|------|------|
| GET /reports/property_pl | 物件別収支サマリ | 建物ごとの収支一覧 + 期間フィルタ |
| GET /reports/aging | 債権滞留表 | エイジング区分別の滞納一覧 |
| GET /reports/payment_summary | 入金実績レポート | 月別入金予定 vs 実績 |

全レポートで CSV ダウンロード（BOM 付き UTF-8）対応。

## 実装ファイル

| ファイル | 内容 |
|---------|------|
| `app/controllers/reports_controller.rb` | 3アクション + CSV出力 + 集計ロジック |
| `app/views/reports/property_pl.html.erb` | 物件別収支サマリ画面 |
| `app/views/reports/aging.html.erb` | 債権滞留表画面 |
| `app/views/reports/payment_summary.html.erb` | 入金実績レポート画面 |

## ルーティング

```ruby
resources :reports, only: [] do
  collection do
    get :property_pl
    get :aging
    get :payment_summary
  end
end
```

## ナビゲーション

ヘッダーに「帳票」メニューグループを追加:
- 物件別収支サマリ
- 債権滞留表
- 入金実績レポート

## テスト

- リクエストスペック: 各レポートの HTML 表示・フィルタ・CSV ダウンロード（9テスト）(**実装済**)
- システムスペック: 各レポートのブラウザ動作確認（6テスト）(**実装済**)
